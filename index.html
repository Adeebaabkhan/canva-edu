<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K-12 Teacher Payslip Generator</title>
    <link rel="stylesheet" href="styles.css">
    <script src="faker.js"></script>
</head>
<body>
    <div class="container">
        <header class="app-header">
            <h1>K-12 Teacher Payslip Generator</h1>
            <p class="subtitle">Generate realistic teacher payslips for K-12 educational institutions worldwide</p>
        </header>

        <div class="form-section">
            <div class="form-container">
                <div class="form-header">
                    <h2>Employee Information</h2>
                    <button type="button" id="auto-generate" class="auto-generate-btn">
                        <span class="icon">üé≤</span> Auto-Generate Data
                    </button>
                </div>

                <form id="payslip-form">
                    <div class="form-group">
                        <div class="input-mode-selector">
                            <label for="name">Full Name:</label>
                            <div class="mode-toggle">
                                <button type="button" class="mode-btn active" data-target="name" data-mode="manual">Manual</button>
                                <button type="button" class="mode-btn" data-target="name" data-mode="auto">Auto-Generate</button>
                            </div>
                        </div>
                        <input type="text" id="name" name="name" placeholder="Enter teacher name" required>
                        <div class="suggestions-container" id="name-suggestions" style="display: none;"></div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="employee-id">Employee ID:</label>
                            <input type="text" id="employee-id" name="employee-id" placeholder="EMP001" required>
                        </div>

                        <div class="form-group">
                            <label for="country">Country:</label>
                            <select id="country" name="country" required>
                                <option value="">Select Country</option>
                                <option value="India">India</option>
                                <option value="USA">United States</option>
                                <option value="UK">United Kingdom</option>
                                <option value="Canada">Canada</option>
                                <option value="Australia">Australia</option>
                                <option value="Singapore">Singapore</option>
                                <option value="Philippines">Philippines</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="input-mode-selector">
                            <label for="school">Select School:</label>
                            <div class="mode-toggle">
                                <button type="button" class="mode-btn active" data-target="school" data-mode="manual">Manual</button>
                                <button type="button" class="mode-btn" data-target="school" data-mode="auto">Auto-Generate</button>
                            </div>
                        </div>
                        <select id="school" name="school" required>
                            <option value="">Please select a country first</option>
                        </select>
                        <input type="text" id="school-manual" name="school-manual" placeholder="Enter school name" style="display: none;">
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="department">Department:</label>
                            <input type="text" id="department" name="department" placeholder="Mathematics Department" required>
                        </div>

                        <div class="form-group">
                            <label for="position">Position:</label>
                            <input type="text" id="position" name="position" placeholder="High School Math Teacher" required>
                        </div>
                    </div>

                    <!-- Enhanced Educational Features -->
                    <div class="form-row">
                        <div class="form-group">
                            <label for="subject">Subject Taught:</label>
                            <select id="subject" name="subject" required>
                                <option value="">Select Subject</option>
                                <option value="Mathematics">Mathematics</option>
                                <option value="English Language Arts">English Language Arts</option>
                                <option value="Science">Science</option>
                                <option value="Biology">Biology</option>
                                <option value="Chemistry">Chemistry</option>
                                <option value="Physics">Physics</option>
                                <option value="Social Studies">Social Studies</option>
                                <option value="History">History</option>
                                <option value="Geography">Geography</option>
                                <option value="Art">Art</option>
                                <option value="Music">Music</option>
                                <option value="Physical Education">Physical Education</option>
                                <option value="Computer Science">Computer Science</option>
                                <option value="Foreign Languages">Foreign Languages</option>
                                <option value="Spanish">Spanish</option>
                                <option value="French">French</option>
                                <option value="Drama/Theater">Drama/Theater</option>
                                <option value="Special Education">Special Education</option>
                                <option value="ESL/ELL">ESL/ELL</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="grade-level">Grade Level:</label>
                            <select id="grade-level" name="grade-level" required>
                                <option value="">Select Grade Level</option>
                                <option value="Elementary (K-5)">Elementary (K-5)</option>
                                <option value="Kindergarten">Kindergarten</option>
                                <option value="Grade 1">Grade 1</option>
                                <option value="Grade 2">Grade 2</option>
                                <option value="Grade 3">Grade 3</option>
                                <option value="Grade 4">Grade 4</option>
                                <option value="Grade 5">Grade 5</option>
                                <option value="Middle School (6-8)">Middle School (6-8)</option>
                                <option value="Grade 6">Grade 6</option>
                                <option value="Grade 7">Grade 7</option>
                                <option value="Grade 8">Grade 8</option>
                                <option value="High School (9-12)">High School (9-12)</option>
                                <option value="Grade 9">Grade 9</option>
                                <option value="Grade 10">Grade 10</option>
                                <option value="Grade 11">Grade 11</option>
                                <option value="Grade 12">Grade 12</option>
                                <option value="Multi-Grade">Multi-Grade</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="position-type">Teaching Position:</label>
                            <select id="position-type" name="position-type" required>
                                <option value="">Select Position Type</option>
                                <option value="Full-time">Full-time</option>
                                <option value="Part-time">Part-time</option>
                                <option value="Substitute">Substitute</option>
                                <option value="Special Education">Special Education</option>
                                <option value="ESL/ELL">ESL/ELL</option>
                                <option value="Department Head">Department Head</option>
                                <option value="Lead Teacher">Lead Teacher</option>
                                <option value="Assistant Teacher">Assistant Teacher</option>
                                <option value="Student Teacher">Student Teacher</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="experience-level">Experience Level:</label>
                            <select id="experience-level" name="experience-level" required>
                                <option value="">Select Experience</option>
                                <option value="entry">Entry Level (0-3 years)</option>
                                <option value="mid">Mid Level (4-10 years)</option>
                                <option value="senior">Senior Level (10+ years)</option>
                                <option value="master">Master Teacher (15+ years)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="basic-salary">Basic Salary:</label>
                            <input type="number" id="basic-salary" name="basic-salary" placeholder="5000" min="1000" max="50000" required>
                        </div>

                        <div class="form-group">
                            <label for="pay-period">Pay Period:</label>
                            <input type="month" id="pay-period" name="pay-period" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="photo">Employee Photo:</label>
                        <input type="file" id="photo" name="photo" accept="image/*">
                        <div class="photo-preview" id="photo-preview"></div>
                    </div>

                    <button type="submit" class="generate-btn">Generate Payslip</button>
                </form>
            </div>
        </div>

        <!-- Enhanced Download Panel (Canva-style) -->
        <div id="download-panel" class="download-panel hidden">
            <div class="download-container">
                <div class="download-header">
                    <h3>Download Options</h3>
                    <button id="close-download" class="close-btn">&times;</button>
                </div>
                
                <div class="format-selector">
                    <h4>Select Format:</h4>
                    <div class="format-buttons">
                        <button class="format-btn active" data-format="pdf">
                            <span class="format-icon">üìÑ</span>
                            <span>PDF</span>
                            <small>Best for printing</small>
                        </button>
                        <button class="format-btn" data-format="jpg">
                            <span class="format-icon">üñºÔ∏è</span>
                            <span>JPG</span>
                            <small>High quality image</small>
                        </button>
                        <button class="format-btn" data-format="png">
                            <span class="format-icon">üé®</span>
                            <span>PNG</span>
                            <small>With transparency</small>
                        </button>
                    </div>
                </div>

                <div class="quality-selector">
                    <h4>Quality:</h4>
                    <div class="quality-options">
                        <input type="range" id="qualitySlider" min="72" max="300" value="150" step="1">
                        <div class="quality-labels">
                            <span>Web (72dpi)</span>
                            <span id="qualityLabel">Print (150dpi)</span>
                            <span>High-res (300dpi)</span>
                        </div>
                    </div>
                </div>

                <div class="size-selector">
                    <h4>Page Size:</h4>
                    <select id="pageSize">
                        <option value="A4">A4 (210 √ó 297 mm)</option>
                        <option value="Letter">Letter (8.5 √ó 11 in)</option>
                        <option value="Legal">Legal (8.5 √ó 14 in)</option>
                        <option value="Custom">Custom Size</option>
                    </select>
                </div>

                <div class="filename-input">
                    <h4>File Name:</h4>
                    <input type="text" id="customFilename" placeholder="PaySlip_SchoolName_TeacherName_Date">
                    <small>Leave empty for auto-generated name</small>
                </div>

                <div class="download-actions">
                    <button id="previewBtn" class="preview-btn">
                        <span>üëÅÔ∏è</span> Preview
                    </button>
                    <button id="downloadBtn" class="download-btn primary">
                        <span>‚¨áÔ∏è</span> Download
                    </button>
                    <button id="bulkDownloadBtn" class="bulk-download-btn">
                        <span>üì¶</span> Bulk Download
                    </button>
                </div>

                <div id="downloadProgress" class="download-progress hidden">
                    <div class="progress-bar">
                        <div class="progress-fill"></div>
                    </div>
                    <span class="progress-text">Preparing download...</span>
                </div>
            </div>
        </div>

        <div id="payslip-output" class="payslip-output hidden"></div>
    </div>
    <script>
        // Currency and tax configurations by country
        const countryConfig = {
            'India': {
                currency: '‚Çπ',
                taxRate: 0.10,
                providentFund: 0.12,
                locale: 'en-IN'
            },
            'USA': {
                currency: '$',
                taxRate: 0.22,
                socialSecurity: 0.062,
                medicare: 0.0145,
                locale: 'en-US'
            },
            'UK': {
                currency: '¬£',
                taxRate: 0.20,
                nationalInsurance: 0.12,
                locale: 'en-GB'
            },
            'Canada': {
                currency: 'CAD $',
                taxRate: 0.15,
                cpp: 0.0545,
                ei: 0.0163,
                locale: 'en-CA'
            },
            'Australia': {
                currency: 'AUD $',
                taxRate: 0.19,
                superannuation: 0.11,
                locale: 'en-AU'
            },
            'Singapore': {
                currency: 'SGD $',
                taxRate: 0.15,
                cpf: 0.20,
                locale: 'en-SG'
            },
            'Philippines': {
                currency: '‚Ç±',
                taxRate: 0.15,
                sss: 0.045,
                locale: 'en-PH'
            }
        };

        // Comprehensive School Database from canva.py
        const SCHOOLS_BY_COUNTRY = {
            "India": [
                "Delhi Public School, R.K. Puram, New Delhi",
                "The Doon School, Dehradun",
                "La Martiniere for Boys, Kolkata",
                "Sanskriti School, New Delhi",
                "Cathedral and John Connon School, Mumbai",
                "Mayo College, Ajmer",
                "Bishop Cotton School, Shimla",
                "Welham Girls' School, Dehradun",
                "Modern School, New Delhi",
                "St. Xavier's Collegiate School, Kolkata",
                "The Lawrence School, Sanawar",
                "Rishi Valley School, Chittoor",
                "Scindia School, Gwalior",
                "Woodstock School, Mussoorie",
                "St. Stephen's School, Chandigarh"
            ],
            "USA": [
                "Lincoln Elementary School, New York",
                "Groton School, Massachusetts",
                "Phillips Exeter Academy, New Hampshire",
                "The Lawrenceville School, New Jersey",
                "Choate Rosemary Hall, Connecticut",
                "Deerfield Academy, Massachusetts",
                "The Hotchkiss School, Connecticut",
                "Milton Academy, Massachusetts",
                "St. Paul's School, New Hampshire",
                "Andover Academy, Massachusetts",
                "Cranbrook Schools, Michigan",
                "The Thacher School, California",
                "Middlesex School, Massachusetts",
                "Cate School, California",
                "St. Mark's School, Massachusetts"
            ],
            "UK": [
                "Hillcrest Primary School, London",
                "Eton College, Berkshire",
                "Harrow School, London",
                "Winchester College, Hampshire",
                "Westminster School, London",
                "Charterhouse School, Surrey",
                "Rugby School, Warwickshire",
                "Marlborough College, Wiltshire",
                "Sherborne School, Dorset",
                "Tonbridge School, Kent",
                "Oundle School, Northamptonshire",
                "Bradfield College, Berkshire",
                "Radley College, Oxfordshire",
                "Uppingham School, Rutland",
                "Stowe School, Buckinghamshire"
            ],
            "Canada": [
                "Upper Canada College, Toronto",
                "St. George's School, Vancouver",
                "Bishop's College School, Quebec",
                "Ridley College, Ontario",
                "Trinity College School, Ontario",
                "Lakefield College School, Ontario",
                "Appleby College, Ontario",
                "Ashbury College, Ottawa",
                "St. Andrew's College, Aurora",
                "Brentwood College School, British Columbia",
                "Shawnigan Lake School, British Columbia",
                "Crescent School, Toronto",
                "The Country Day School, Ontario",
                "Royal St. George's College, Toronto",
                "Havergal College, Toronto"
            ],
            "Australia": [
                "Sydney Grammar School, New South Wales",
                "Melbourne Grammar School, Victoria",
                "Scotch College, Melbourne",
                "The King's School, Parramatta",
                "Geelong Grammar School, Victoria",
                "Brisbane Grammar School, Queensland",
                "Adelaide Hills School, South Australia",
                "St Peter's College, Adelaide",
                "Hale School, Perth",
                "Christ Church Grammar School, Western Australia",
                "Shore School, Sydney",
                "Knox Grammar School, New South Wales",
                "Trinity Grammar School, Melbourne",
                "Barker College, New South Wales",
                "Newington College, Sydney"
            ],
            "Singapore": [
                "Raffles Institution, Singapore",
                "Hwa Chong Institution, Singapore",
                "National Junior College, Singapore",
                "Victoria Junior College, Singapore",
                "Anglo-Chinese School, Singapore",
                "Singapore American School, Singapore",
                "United World College, Singapore",
                "Overseas Family School, Singapore",
                "Canadian International School, Singapore",
                "German European School, Singapore",
                "Australian International School, Singapore",
                "Chatsworth International School, Singapore",
                "Tanglin Trust School, Singapore",
                "NEXUS International School, Singapore",
                "Stamford American International School, Singapore"
            ],
            "Philippines": [
                "Ateneo de Manila University, Quezon City",
                "De La Salle University, Manila",
                "University of the Philippines, Diliman",
                "Xavier School, San Juan",
                "Immaculate Conception Academy, Greenhills",
                "Miriam College, Quezon City",
                "St. Scholastica's College, Manila",
                "Assumption College, Makati",
                "Philippine Science High School, Quezon City",
                "International School Manila, Taguig",
                "British School Manila, Taguig",
                "Brent International School, Manila",
                "Southville International School, Las Pi√±as",
                "Faith Academy, Manila",
                "Colegio San Agustin, Makati"
            ]
        };

        // Function to populate schools based on selected country
        function populateSchools(country) {
            const schoolSelect = document.getElementById('school');
            schoolSelect.innerHTML = '<option value="">Select a school</option>';
            
            if (country && SCHOOLS_BY_COUNTRY[country]) {
                SCHOOLS_BY_COUNTRY[country].forEach(school => {
                    const option = document.createElement('option');
                    option.value = school;
                    option.textContent = school;
                    schoolSelect.appendChild(option);
                });
            } else {
                schoolSelect.innerHTML = '<option value="">Please select a country first</option>';
            }
        }

        // Function to extract school name and location
        function parseSchool(schoolString) {
            const parts = schoolString.split(', ');
            const schoolName = parts[0];
            const location = parts.slice(1).join(', ');
            return { name: schoolName, location: location };
        }

        // Initialize Faker for different locales
        function initializeFaker(country) {
            switch(country) {
                case 'UK':
                    faker.locale = 'en_GB';
                    break;
                case 'Canada':
                    faker.locale = 'en_CA';
                    break;
                default:
                    faker.locale = 'en_US';
            }
        }

        // Auto-generate realistic employee data
        function autoGenerateData() {
            // First select a random country if none selected
            const countrySelect = document.getElementById('country');
            if (!countrySelect.value) {
                const countries = ['India', 'USA', 'UK', 'Canada', 'Australia', 'Singapore', 'Philippines'];
                countrySelect.value = faker.random.arrayElement(countries);
                populateSchools(countrySelect.value);
            }
            
            const country = countrySelect.value;
            initializeFaker(country);

            // Generate realistic K-12 teacher data
            const teacherName = faker.name.teacherName(country);
            const experienceLevel = faker.random.arrayElement(['entry', 'mid', 'senior', 'master']);
            
            document.getElementById('name').value = teacherName;
            document.getElementById('employee-id').value = faker.generateTeacherID(country);
            document.getElementById('department').value = faker.random.arrayElement(faker.education.departments);
            document.getElementById('position').value = faker.random.arrayElement(faker.education.jobTitles);
            
            // Populate new educational fields
            document.getElementById('subject').value = faker.random.arrayElement(faker.education.subjects);
            document.getElementById('grade-level').value = faker.random.arrayElement(faker.education.gradeLevels);
            document.getElementById('position-type').value = faker.random.arrayElement(faker.education.positionTypes);
            document.getElementById('experience-level').value = experienceLevel;
            
            document.getElementById('basic-salary').value = faker.generateTeacherSalary(country, experienceLevel);
            
            // Select a random school
            const schoolSelect = document.getElementById('school');
            if (SCHOOLS_BY_COUNTRY[country] && SCHOOLS_BY_COUNTRY[country].length > 0) {
                schoolSelect.value = faker.random.arrayElement(SCHOOLS_BY_COUNTRY[country]);
            }
            
            // Set academic year month (September as default for academic calendar)
            const currentDate = new Date();
            let academicMonth = 9; // September
            let academicYear = currentDate.getFullYear();
            
            // If we're in Jan-Aug, use previous academic year
            if (currentDate.getMonth() + 1 < 9) {
                academicYear = academicYear - 1;
            }
            
            const monthString = `${academicYear}-${String(academicMonth).padStart(2, '0')}`;
            document.getElementById('pay-period').value = monthString;
        }

        // Calculate salary breakdown
        function calculateSalary(basicSalary, country) {
            const config = countryConfig[country];
            const gross = parseFloat(basicSalary);
            
            let deductions = {};
            let benefits = {};
            let totalDeductions = 0;
            let totalBenefits = 0;

            // Enhanced K-12 Teacher Benefits (added to gross)
            const profDevAllowance = gross * 0.05; // 5% professional development allowance
            const educationGrant = gross * 0.03;   // 3% education grant
            const classroomSupplies = gross * 0.02; // 2% classroom supply stipend
            const technologyAllowance = gross * 0.015; // 1.5% technology allowance
            
            benefits['Professional Development'] = profDevAllowance;
            benefits['Education Grant'] = educationGrant;
            benefits['Classroom Supplies'] = classroomSupplies;
            benefits['Technology Allowance'] = technologyAllowance;
            
            // Additional benefits for higher experience levels or positions
            const healthInsuranceValue = gross * 0.08; // 8% health insurance employer contribution
            benefits['Health Insurance (Employer)'] = healthInsuranceValue;
            
            totalBenefits += profDevAllowance + educationGrant + classroomSupplies + technologyAllowance + healthInsuranceValue;

            const grossWithBenefits = gross + totalBenefits;

            // Calculate tax on gross with benefits
            const incomeTax = grossWithBenefits * config.taxRate;
            deductions['Income Tax'] = incomeTax;
            totalDeductions += incomeTax;

            // Enhanced K-12 Teacher specific deductions
            const teacherUnionFee = gross * 0.02;     // 2% teacher union fee
            const continuingEducation = gross * 0.015; // 1.5% continuing education
            const healthInsuranceEmp = gross * 0.04;   // 4% employee health insurance contribution
            const professionalLiability = gross * 0.005; // 0.5% professional liability insurance
            
            deductions['Teacher Union Fee'] = teacherUnionFee;
            deductions['Continuing Education'] = continuingEducation;
            deductions['Health Insurance (Employee)'] = healthInsuranceEmp;
            deductions['Professional Liability'] = professionalLiability;
            
            totalDeductions += teacherUnionFee + continuingEducation + healthInsuranceEmp + professionalLiability;

            // Country-specific deductions and retirement
            if (country === 'India') {
                const providentFund = grossWithBenefits * config.providentFund;
                const esi = gross * 0.0175; // Employee State Insurance
                deductions['Provident Fund'] = providentFund;
                deductions['ESI'] = esi;
                totalDeductions += providentFund + esi;
            } else if (country === 'USA') {
                const socialSecurity = grossWithBenefits * config.socialSecurity;
                const medicare = grossWithBenefits * config.medicare;
                const retirement403b = gross * 0.05; // 5% 403(b) contribution
                deductions['Social Security'] = socialSecurity;
                deductions['Medicare'] = medicare;
                deductions['403(b) Retirement'] = retirement403b;
                totalDeductions += socialSecurity + medicare + retirement403b;
            } else if (country === 'UK') {
                const nationalInsurance = grossWithBenefits * config.nationalInsurance;
                const teachersPension = gross * 0.072; // Teacher's Pension Scheme
                deductions['National Insurance'] = nationalInsurance;
                deductions['Teachers Pension'] = teachersPension;
                totalDeductions += nationalInsurance + teachersPension;
            } else if (country === 'Canada') {
                const cpp = grossWithBenefits * config.cpp;
                const ei = grossWithBenefits * config.ei;
                const teachersPension = gross * 0.08; // Teachers' Pension Plan
                deductions['CPP'] = cpp;
                deductions['Employment Insurance'] = ei;
                deductions['Teachers Pension'] = teachersPension;
                totalDeductions += cpp + ei + teachersPension;
            } else if (country === 'Australia') {
                const superannuation = grossWithBenefits * config.superannuation;
                deductions['Superannuation'] = superannuation;
                totalDeductions += superannuation;
            } else if (country === 'Singapore') {
                const cpf = grossWithBenefits * config.cpf;
                deductions['CPF'] = cpf;
                totalDeductions += cpf;
            } else if (country === 'Philippines') {
                const sss = grossWithBenefits * config.sss;
                const pagibig = gross * 0.02; // Pag-IBIG Fund
                const philhealth = gross * 0.025; // PhilHealth
                deductions['SSS'] = sss;
                deductions['Pag-IBIG'] = pagibig;
                deductions['PhilHealth'] = philhealth;
                totalDeductions += sss + pagibig + philhealth;
            }

            const netSalary = grossWithBenefits - totalDeductions;

            return {
                gross,
                grossWithBenefits,
                benefits,
                totalBenefits,
                deductions,
                totalDeductions,
                netSalary,
                currency: config.currency
            };
        }

        // Format currency
        function formatCurrency(amount, country) {
            const config = countryConfig[country];
            const currencyMap = {
                'India': 'INR',
                'USA': 'USD',
                'UK': 'GBP',
                'Canada': 'CAD',
                'Australia': 'AUD',
                'Singapore': 'SGD',
                'Philippines': 'PHP'
            };
            
            return new Intl.NumberFormat(config.locale, {
                style: 'currency',
                currency: currencyMap[country] || 'USD'
            }).format(amount);
        }

        // Generate professional payslip
        function generatePayslip(formData, photoUrl) {
            const country = formData.get('country');
            let schoolString = formData.get('school');
            
            // Handle manual school input
            if (!schoolString || schoolString === '') {
                schoolString = formData.get('school-manual') || 'Educational Institution, Location';
            }
            
            const basicSalary = formData.get('basic-salary');
            const salaryBreakdown = calculateSalary(basicSalary, country);
            
            // Parse school information
            const school = parseSchool(schoolString);
            const schoolInitials = school.name.split(' ').map(word => word[0]).join('').substring(0, 2).toUpperCase();
            
            const payPeriod = new Date(formData.get('pay-period') + '-01');
            const payPeriodStr = payPeriod.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long' 
            });

            return `
                <div class="payslip-document">
                    <div class="company-header">
                        <div class="company-logo">
                            <div class="logo-circle">${schoolInitials}</div>
                        </div>
                        <div class="company-info">
                            <h1>${school.name.toUpperCase()}</h1>
                            <p>Educational Excellence & Professional Development</p>
                            <div class="company-details">
                                <p>${school.location}</p>
                                <p>Education | Training | Professional Services</p>
                            </div>
                        </div>
                    </div>

                    <div class="payslip-header">
                        <h2>PAYSLIP / SALARY STATEMENT</h2>
                        <div class="pay-period">Pay Period: ${payPeriodStr} | Employee ID: ${formData.get('employee-id')}</div>
                    </div>

                    <div class="employee-section">
                        <div class="employee-info">
                            <div class="info-grid">
                                <div class="info-item">
                                    <label>Employee Name:</label>
                                    <span>${formData.get('name')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Employee ID:</label>
                                    <span>${formData.get('employee-id')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Department:</label>
                                    <span>${formData.get('department')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Position:</label>
                                    <span>${formData.get('position')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Subject:</label>
                                    <span>${formData.get('subject')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Grade Level:</label>
                                    <span>${formData.get('grade-level')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Position Type:</label>
                                    <span>${formData.get('position-type')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Experience:</label>
                                    <span>${formData.get('experience-level')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Country:</label>
                                    <span>${formData.get('country')}</span>
                                </div>
                                <div class="info-item">
                                    <label>Pay Date:</label>
                                    <span>${new Date().toLocaleDateString()}</span>
                                </div>
                            </div>
                        </div>
                        ${photoUrl ? `<div class="employee-photo"><img src="${photoUrl}" alt="Employee Photo"></div>` : ''}
                    </div>

                    <div class="salary-section">
                        <div class="earnings-section">
                            <h3>Earnings & Benefits</h3>
                            <div class="salary-item">
                                <span>Basic Salary</span>
                                <span class="amount">${formatCurrency(salaryBreakdown.gross, country)}</span>
                            </div>
                            ${Object.entries(salaryBreakdown.benefits).map(([key, value]) => 
                                `<div class="salary-item benefit-item">
                                    <span>${key}</span>
                                    <span class="amount">+${formatCurrency(value, country)}</span>
                                </div>`
                            ).join('')}
                            <div class="salary-total">
                                <span>Gross Earnings (incl. Benefits)</span>
                                <span class="amount">${formatCurrency(salaryBreakdown.grossWithBenefits, country)}</span>
                            </div>
                        </div>

                        <div class="deductions-section">
                            <h3>Deductions</h3>
                            ${Object.entries(salaryBreakdown.deductions).map(([key, value]) => 
                                `<div class="salary-item">
                                    <span>${key}</span>
                                    <span class="amount">-${formatCurrency(value, country)}</span>
                                </div>`
                            ).join('')}
                            <div class="salary-total deduction-total">
                                <span>Total Deductions</span>
                                <span class="amount">-${formatCurrency(salaryBreakdown.totalDeductions, country)}</span>
                            </div>
                        </div>
                    </div>

                    <div class="net-pay-section">
                        <div class="net-pay">
                            <span>Net Pay</span>
                            <span class="amount">${formatCurrency(salaryBreakdown.netSalary, country)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Setup mode toggle functionality
        function setupModeToggles() {
            const modeButtons = document.querySelectorAll('.mode-btn');
            
            modeButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const target = this.dataset.target;
                    const mode = this.dataset.mode;
                    const targetGroup = this.closest('.form-group');
                    const siblingButtons = targetGroup.querySelectorAll('.mode-btn');
                    
                    // Update button states
                    siblingButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Toggle input visibility and functionality
                    if (target === 'school') {
                        const selectElement = document.getElementById('school');
                        const manualInput = document.getElementById('school-manual');
                        
                        if (mode === 'manual') {
                            selectElement.style.display = 'none';
                            manualInput.style.display = 'block';
                            manualInput.required = true;
                            selectElement.required = false;
                        } else {
                            selectElement.style.display = 'block';
                            manualInput.style.display = 'none';
                            selectElement.required = true;
                            manualInput.required = false;
                        }
                    } else if (target === 'name') {
                        const nameInput = document.getElementById('name');
                        if (mode === 'auto') {
                            showNameSuggestions();
                        } else {
                            hideNameSuggestions();
                        }
                    }
                });
            });
        }

        // Show name suggestions
        function showNameSuggestions() {
            const country = document.getElementById('country').value;
            if (!country) return;
            
            const suggestionsContainer = document.getElementById('name-suggestions');
            suggestionsContainer.style.display = 'block';
            
            // Generate 5 random teacher names
            const suggestions = [];
            for (let i = 0; i < 5; i++) {
                suggestions.push(faker.name.teacherName(country));
            }
            
            suggestionsContainer.innerHTML = suggestions.map(name => 
                `<div class="suggestion-item" onclick="selectNameSuggestion('${name}')">${name}</div>`
            ).join('');
        }

        // Hide name suggestions
        function hideNameSuggestions() {
            const suggestionsContainer = document.getElementById('name-suggestions');
            suggestionsContainer.style.display = 'none';
        }

        // Select name suggestion
        function selectNameSuggestion(name) {
            document.getElementById('name').value = name;
            hideNameSuggestions();
        }

        // Handle photo preview
        function handlePhotoUpload(event) {
            const file = event.target.files[0];
            const preview = document.getElementById('photo-preview');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    preview.innerHTML = `<img src="${e.target.result}" alt="Photo Preview">`;
                };
                reader.readAsDataURL(file);
            } else {
                preview.innerHTML = '';
            }
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Auto-generate button
            document.getElementById('auto-generate').addEventListener('click', autoGenerateData);
            
            // Photo upload
            document.getElementById('photo').addEventListener('change', handlePhotoUpload);
            
            // Country selection to populate schools
            document.getElementById('country').addEventListener('change', function(event) {
                populateSchools(event.target.value);
            });

            // Mode toggle functionality
            setupModeToggles();
            
            // Form submission
            document.getElementById('payslip-form').addEventListener('submit', function(event) {
                event.preventDefault();
                
                const formData = new FormData(event.target);
                const photoFile = document.getElementById('photo').files[0];
                let photoUrl = null;
                
                if (photoFile) {
                    photoUrl = URL.createObjectURL(photoFile);
                }
                
                const payslipHTML = generatePayslip(formData, photoUrl);
                const outputDiv = document.getElementById('payslip-output');
                
                outputDiv.innerHTML = payslipHTML;
                outputDiv.classList.remove('hidden');
                
                // Show download panel after payslip is generated
                document.getElementById('download-panel').classList.remove('hidden');
                
                // Scroll to output
                outputDiv.scrollIntoView({ behavior: 'smooth' });
            });
            
            // Enhanced Download System (Canva-like)
            setupDownloadSystem();
        });

        // Download System Setup
        function setupDownloadSystem() {
            const downloadPanel = document.getElementById('download-panel');
            const formatButtons = document.querySelectorAll('.format-btn');
            const qualitySlider = document.getElementById('qualitySlider');
            const qualityLabel = document.getElementById('qualityLabel');
            const previewBtn = document.getElementById('previewBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const bulkDownloadBtn = document.getElementById('bulkDownloadBtn');
            const closeBtn = document.getElementById('close-download');

            // Format selection
            formatButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    formatButtons.forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                });
            });

            // Quality slider
            qualitySlider.addEventListener('input', function() {
                const value = this.value;
                let label = '';
                if (value <= 100) label = `Web (${value}dpi)`;
                else if (value <= 200) label = `Print (${value}dpi)`;
                else label = `High-res (${value}dpi)`;
                qualityLabel.textContent = label;
            });

            // Close download panel
            closeBtn.addEventListener('click', function() {
                downloadPanel.classList.add('hidden');
            });

            // Preview functionality
            previewBtn.addEventListener('click', function() {
                showPreviewModal();
            });

            // Download functionality
            downloadBtn.addEventListener('click', function() {
                const format = document.querySelector('.format-btn.active').dataset.format;
                const quality = parseInt(qualitySlider.value);
                const customName = document.getElementById('customFilename').value;
                downloadPayslip(format, quality, customName);
            });

            // Bulk download functionality
            bulkDownloadBtn.addEventListener('click', function() {
                showBulkDownloadModal();
            });
        }

        // Download payslip function (simplified)
        async function downloadPayslip(format, quality, customName) {
            const payslipElement = document.querySelector('.payslip-document');
            if (!payslipElement) {
                alert('Please generate a payslip first!');
                return;
            }

            // Show progress
            showDownloadProgress();

            try {
                const filename = customName || generateSmartFilename();
                
                if (format === 'pdf') {
                    // Use browser's print to PDF functionality
                    setTimeout(() => {
                        window.print();
                        hideDownloadProgress();
                    }, 1000);
                } else {
                    // For now, show message about image formats
                    alert(`${format.toUpperCase()} download will be available once external libraries are loaded. For now, you can use Print to PDF or take a screenshot.`);
                    hideDownloadProgress();
                }

                addToDownloadHistory(filename);
            } catch (error) {
                console.error('Download failed:', error);
                alert('Download failed. Please try again.');
                hideDownloadProgress();
            }
        }

        // Simplified PDF download using print
        async function downloadAsPDF(element, filename, quality) {
            window.print();
        }

        // Placeholder for image download
        async function downloadAsImage(element, filename, format, quality) {
            alert(`${format.toUpperCase()} download feature coming soon!`);
        }

        // Generate smart filename
        function generateSmartFilename() {
            const employeeName = document.getElementById('name').value || 'Teacher';
            const school = document.getElementById('school').selectedOptions[0]?.text?.split(',')[0] || 'School';
            const payPeriod = document.getElementById('pay-period').value || '';
            const date = payPeriod ? payPeriod.replace('-', '') : new Date().toISOString().slice(0, 7).replace('-', '');
            
            const cleanName = employeeName.replace(/[^a-zA-Z0-9]/g, '');
            const cleanSchool = school.replace(/[^a-zA-Z0-9]/g, '').slice(0, 15);
            
            return `PaySlip_${cleanSchool}_${cleanName}_${date}`;
        }

        // Show download progress
        function showDownloadProgress() {
            const progress = document.getElementById('downloadProgress');
            progress.classList.remove('hidden');
            
            // Animate progress bar
            const progressFill = progress.querySelector('.progress-fill');
            progressFill.style.width = '0%';
            setTimeout(() => {
                progressFill.style.width = '100%';
            }, 100);
        }

        // Hide download progress
        function hideDownloadProgress() {
            setTimeout(() => {
                document.getElementById('downloadProgress').classList.add('hidden');
            }, 1000);
        }

        // Add to download history (localStorage)
        function addToDownloadHistory(filename) {
            const history = JSON.parse(localStorage.getItem('downloadHistory') || '[]');
            history.unshift({
                filename,
                date: new Date().toISOString(),
                type: 'payslip'
            });
            
            // Keep only last 10 downloads
            if (history.length > 10) history.splice(10);
            
            localStorage.setItem('downloadHistory', JSON.stringify(history));
        }

        // Show preview modal
        function showPreviewModal() {
            const payslipElement = document.querySelector('.payslip-document');
            if (!payslipElement) {
                alert('Please generate a payslip first!');
                return;
            }

            // Create modal
            const modal = document.createElement('div');
            modal.className = 'preview-modal';
            modal.innerHTML = `
                <div class="preview-content">
                    <div class="preview-header">
                        <h3>Payslip Preview</h3>
                        <button class="close-preview">&times;</button>
                    </div>
                    <div class="preview-body">
                        ${payslipElement.outerHTML}
                    </div>
                </div>
            `;

            document.body.appendChild(modal);

            // Close modal
            modal.querySelector('.close-preview').addEventListener('click', () => {
                document.body.removeChild(modal);
            });

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // Show bulk download modal
        function showBulkDownloadModal() {
            alert('Bulk download feature: Generate multiple teacher payslips and download them as a ZIP file. This feature would allow batch processing of multiple teachers at once.');
        }
    </script>
</body>
</html>